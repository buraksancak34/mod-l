<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Derya & ƒ∞lker - Bizim D√ºnyamƒ±z</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap');

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #fff5f5 0%, #fff1f2 100%);
            color: #4c0519;
            margin: 0; padding: 0; overflow-x: hidden; min-height: 100vh;
        }

        .romantic-font { font-family: 'Dancing Script', cursive; }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(255, 192, 203, 0.6);
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 40px rgba(159, 18, 57, 0.05);
            transition: all 0.4s ease;
        }
        
        .glass-card:hover { transform: translateY(-3px); box-shadow: 0 15px 50px rgba(159, 18, 57, 0.1); border-color: #fda4af; }

        .admin-sidebar {
            background: rgba(255, 255, 255, 0.98);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -15px 0 50px rgba(0, 0, 0, 0.08);
            z-index: 999999;
        }

        .custom-input {
            background: #fff !important; border: 2px solid #ffe4e6 !important;
            color: #881337 !important; padding: 12px !important;
            border-radius: 16px !important; width: 100% !important;
        }
        .custom-input:focus { border-color: #fb7185 !important; outline: none; }

        .btn-love {
            background: linear-gradient(135deg, #fb7185 0%, #e11d48 100%);
            color: white; border-radius: 20px; font-weight: 700;
            transition: all 0.3s; cursor: pointer; border: none;
        }
        .btn-love:hover { filter: brightness(1.1); transform: scale(1.05); }

        /* Mesajla≈üma */
        .chat-bubble {
            max-width: 85%; padding: 12px 16px; border-radius: 18px;
            position: relative; margin-bottom: 8px; font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .chat-bubble.sent { background: #e11d48; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-bubble.received { background: #fff; color: #881337; align-self: flex-start; border: 1px solid #ffe4e6; border-bottom-left-radius: 2px; }
        .chat-meta { font-size: 0.6rem; margin-top: 4px; opacity: 0.8; text-align: right; }

        /* Gizli Kart (Uzman G√∂r√º≈ü√º) */
        .blur-reveal-container {
            position: relative; overflow: hidden; border-radius: 1.5rem;
            background: white; border: 2px dashed #fda4af;
            transition: all 0.5s ease; cursor: pointer;
            min-height: 100px;
        }
        .blur-overlay {
            position: absolute; inset: 0;
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(12px);
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            z-index: 10; transition: opacity 0.5s ease;
        }
        .blur-reveal-container.revealed .blur-overlay { opacity: 0; pointer-events: none; }
        .blur-reveal-container.revealed { border-style: solid; border-color: #e11d48; }

        /* Talepler (Zarf) */
        .request-envelope {
            background: #fff; border: 1px solid #ffe4e6;
            padding: 15px; border-radius: 16px; margin-bottom: 10px;
            cursor: pointer; transition: all 0.3s;
        }
        .request-envelope:hover { background: #fff0f3; }
        .request-content { display: none; margin-top: 10px; color: #881337; font-weight: 600; padding-top: 10px; border-top: 1px dashed #fecdd3; }
        .request-envelope.open .request-content { display: block; animation: fadeIn 0.5s; }
        
        .hidden-mode { display: none !important; }
        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #4c0519; color: white; padding: 12px 24px; border-radius: 50px; font-size: 14px; font-weight: 600; z-index: 1000000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }

        /* Motto Alanƒ± */
        #motto-section {
            background: #fff0f3; color: #be123c; padding: 10px; text-align: center;
            font-style: italic; font-weight: 600; font-size: 0.9rem; border-bottom: 1px solid #fecdd3;
        }

        /* Swiper */
        .swiper-slide { height: auto; display: flex; align-items: center; justify-content: center; text-align: center; }
        .memory-img-col img { width: 100%; height: 250px; object-fit: cover; border-radius: 1rem; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="antialiased pb-32" onclick="playMusicOnFirstInteraction()">

    <div id="toast">ƒ∞≈ülem Ba≈üarƒ±lƒ±!</div>
    <div id="player" style="display:none;"></div>

    <!-- Motto (Herkese A√ßƒ±k) -->
    <div id="motto-section">
        <span id="daily-motto">Aile, sevginin ba≈üladƒ±ƒüƒ± yerdir.</span>
    </div>

    <!-- M√ºzik Barƒ± -->
    <div id="music-player-bar" class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur border-t border-rose-100 p-3 flex justify-between items-center z-50 shadow-lg">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-rose-100 rounded-full flex items-center justify-center text-rose-500 animate-spin-slow">üéµ</div>
            <div class="flex-1 min-w-0 pr-4">
                <p id="music-title" class="text-xs font-bold text-rose-900 truncate">M√ºzik Y√ºkleniyor...</p>
            </div>
        </div>
        <div class="flex gap-4 items-center">
            <button onclick="window.prevSong()" class="text-rose-400 text-xl">‚èÆ</button>
            <button onclick="window.togglePlay()" id="play-btn" class="text-rose-600 text-2xl">‚ñ∂</button>
            <button onclick="window.nextSong()" class="text-rose-400 text-xl">‚è≠</button>
        </div>
    </div>

    <!-- Admin Paneli -->
    <div id="admin-panel" class="fixed top-0 right-0 h-full w-80 admin-sidebar translate-x-full overflow-y-auto p-8 border-l border-rose-100">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-xl font-black text-rose-800">üõ†Ô∏è Y√∂netim</h2>
            <button onclick="window.toggleAdmin()" class="text-rose-400 text-3xl">&times;</button>
        </div>
        
        <div class="space-y-2 mb-6">
            <button onclick="window.switchTab('quotes')" class="w-full py-2 bg-rose-100 text-rose-600 rounded-lg text-xs font-bold">365 G√ºn</button>
            <button onclick="window.switchTab('mottos')" class="w-full py-2 bg-rose-100 text-rose-600 rounded-lg text-xs font-bold">Mottolar</button>
            <button onclick="window.switchTab('expert')" class="w-full py-2 bg-rose-100 text-rose-600 rounded-lg text-xs font-bold">Uzman G√∂r√º≈ü√º</button>
        </div>

        <div id="sidebar-quotes-content">
            <h3 class="text-rose-600 text-xs font-black uppercase mb-2">G√ºne √ñzel Mesaj</h3>
            <input type="date" id="quote-date" class="custom-input mb-2">
            <textarea id="daily-quote-text" placeholder="Mesajƒ±nƒ±z..." class="custom-input h-24 mb-2"></textarea>
            <button onclick="window.saveDailyQuote()" class="w-full py-3 btn-love text-xs">KAYDET</button>
            <div id="saved-quotes-list" class="mt-4 space-y-1 max-h-40 overflow-y-auto"></div>
        </div>

        <div id="sidebar-mottos-content" class="hidden">
            <h3 class="text-rose-600 text-xs font-black uppercase mb-2">Motto Ekle</h3>
            <textarea id="new-motto-text" placeholder="S√∂z..." class="custom-input h-20 mb-2"></textarea>
            <button onclick="window.addMotto()" class="w-full py-3 btn-love text-xs">EKLE</button>
            <div id="motto-list" class="mt-4 space-y-1 max-h-40 overflow-y-auto"></div>
        </div>

        <div id="sidebar-expert-content" class="hidden">
            <h3 class="text-rose-600 text-xs font-black uppercase mb-2">Uzman Bilgisi Ekle</h3>
            <textarea id="new-expert-text" placeholder="Bilgi..." class="custom-input h-20 mb-2"></textarea>
            <button onclick="window.addExpertTip()" class="w-full py-3 btn-love text-xs">EKLE</button>
        </div>
    </div>

    <!-- Ana ƒ∞√ßerik -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Ba≈ülƒ±k & Giri≈ü -->
        <header class="flex flex-col md:flex-row justify-between items-start mb-12 gap-8">
            <div class="flex-1 w-full text-center md:text-left">
                <h1 class="text-5xl md:text-7xl romantic-font text-rose-600">Derya & ƒ∞lker</h1>
                <p class="text-rose-400 text-sm mt-2 font-medium">14 yƒ±ldƒ±r aynƒ± g√∂ky√ºz√ºne bakmak... <span class="heart-beat">‚ô•</span></p>
                
                <div class="mt-6 flex flex-wrap gap-3 justify-center md:justify-start items-center">
                    <div id="mode-status" class="bg-white px-4 py-1.5 rounded-full border border-rose-100 text-rose-400 text-[10px] font-black uppercase shadow-sm">G√∂zlemci</div>
                    <button onclick="window.login('Derya')" class="text-xs font-bold text-rose-500 hover:underline">Derya</button>
                    <span class="text-rose-200">|</span>
                    <button onclick="window.login('ƒ∞lker')" class="text-xs font-bold text-rose-500 hover:underline">ƒ∞lker</button>
                    <button onclick="window.toggleAdmin()" id="manage-btn" class="hidden-mode text-xl ml-2">‚öôÔ∏è</button>
                    <button onclick="window.logout()" id="logout-btn" class="hidden-mode text-xs font-bold text-rose-300 ml-2">√áƒ±kƒ±≈ü</button>
                </div>

                <div id="daily-quote-area" class="mt-6 glass-card p-6 rounded-3xl text-center">
                    <h4 class="text-[9px] font-black text-rose-300 uppercase tracking-widest mb-2">G√ºn√ºn Kalp Atƒ±≈üƒ±</h4>
                    <p id="current-quote" class="text-rose-800 text-xl font-bold italic font-serif">Giri≈ü yapƒ±ldƒ±ƒüƒ±nda y√ºklenecek...</p>
                </div>
            </div>

            <!-- Saya√ßlar (Giri≈ü Yapƒ±lƒ±nca) -->
            <div id="counters-panel" class="hidden-mode w-full md:w-64 flex flex-row md:flex-col gap-3">
                <div class="glass-card p-4 rounded-2xl text-center flex-1">
                    <div id="marriage-counter" class="text-3xl font-black text-rose-600">...</div>
                    <p class="text-rose-300 text-[9px] font-bold uppercase">Evlilik G√ºn√º</p>
                </div>
                <div class="glass-card p-4 rounded-2xl text-center flex-1">
                    <div id="meeting-counter" class="text-2xl font-black text-rose-400">...</div>
                    <p class="text-rose-300 text-[9px] font-bold uppercase">Birliktelik G√ºn√º</p>
                </div>
            </div>
        </header>

        <!-- Gƒ∞ZLƒ∞ ƒ∞√áERƒ∞KLER -->
        <div id="private-content" class="hidden-mode space-y-12">
            
            <!-- 1. Gƒ∞ZLƒ∞ UZMAN KARTI -->
            <div class="blur-reveal-container" onclick="this.classList.add('revealed')">
                <div class="blur-overlay">
                    <span class="text-3xl mb-1">üîí</span>
                    <p class="text-xs font-black text-rose-600 uppercase">Bizim ƒ∞√ßin √ñzel Bilgiler</p>
                    <p class="text-[9px] text-rose-400 mt-1 animate-bounce">Okumak i√ßin tƒ±kla</p>
                </div>
                <div class="bg-rose-50 p-6">
                    <h3 class="text-center text-rose-800 font-bold text-xs uppercase mb-4 tracking-widest">‚ù§Ô∏è A≈ük ve Yakƒ±nlƒ±k √úzerine Notlar</h3>
                    <div class="swiper expertSwiper h-32">
                        <div class="swiper-wrapper" id="expert-slides"></div>
                        <div class="swiper-pagination"></div>
                    </div>
                </div>
            </div>

            <!-- 2. MESAJLA≈ûMA VE TALEPLER (YAN YANA) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Sol: Mesajlar -->
                <div class="glass-card p-6 rounded-[2rem] h-[500px] flex flex-col">
                    <h2 class="text-lg font-black text-rose-900 uppercase mb-4 pl-2">üíå Mesaj Kutusu</h2>
                    <div id="chat-box" class="flex-1 overflow-y-auto p-2 flex flex-col-reverse space-y-reverse space-y-3 mb-3 bg-white/50 rounded-xl"></div>
                    <div class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="Bir mesaj yaz..." class="custom-input h-12 text-sm">
                        <button onclick="window.sendChat()" class="w-12 h-12 bg-rose-500 rounded-full text-white shadow-lg text-lg flex items-center justify-center">‚û§</button>
                    </div>
                </div>

                <!-- Saƒü: Talepler -->
                <div class="glass-card p-6 rounded-[2rem] h-[500px] flex flex-col overflow-hidden">
                    <h2 class="text-lg font-black text-rose-900 uppercase mb-4 pl-2">üí´ Kalpten Talepler</h2>
                    
                    <div class="flex-1 overflow-y-auto pr-2 space-y-4">
                        <!-- Gelen Talepler -->
                        <div>
                            <h3 id="incoming-req-title" class="text-xs font-bold text-indigo-500 uppercase mb-2">Gelen Talepler (Okunacak)</h3>
                            <div id="incoming-requests" class="space-y-2"></div>
                        </div>

                        <!-- Giden Talepler -->
                        <div>
                            <h3 id="outgoing-req-title" class="text-xs font-bold text-rose-500 uppercase mb-2">Senin Taleplerin</h3>
                            <div class="flex gap-2 mb-3">
                                <input type="text" id="request-input" placeholder="Ne istersin?" class="custom-input h-10 text-xs">
                                <button onclick="window.addRequest()" class="bg-rose-500 text-white rounded-xl px-4 text-xs font-bold">+</button>
                            </div>
                            <div id="outgoing-requests" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. ANI DEFTERƒ∞ (ANA SAYFADA EKLEME) -->
            <section>
                <h2 class="text-2xl font-black text-rose-900 uppercase mb-6 px-2">üìñ Anƒ± Defteri</h2>
                
                <!-- Anƒ± Ekleme Formu -->
                <div class="glass-card p-6 rounded-3xl mb-8 border-rose-200">
                    <h4 class="text-xs font-black text-rose-500 uppercase mb-4">‚ú® Yeni Bir Anƒ± Kaydet</h4>
                    <div class="flex flex-col md:flex-row gap-4 items-start">
                        <input type="file" id="memory-file" accept="image/*" class="text-xs w-full text-rose-800">
                        <input type="date" id="memory-date" class="custom-input h-10 text-xs">
                        <textarea id="memory-desc" placeholder="Hikayesi..." class="custom-input h-10 resize-none pt-2 text-xs"></textarea>
                        <button onclick="window.saveMemory()" class="w-full md:w-auto px-6 py-2 btn-love text-xs font-bold uppercase h-10">KAYDET</button>
                    </div>
                </div>

                <!-- Anƒ± Slider -->
                <div class="swiper memorySwiper pb-10">
                    <div class="swiper-wrapper" id="memory-slides"></div>
                    <div class="swiper-pagination"></div>
                </div>
            </section>

        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, deleteDoc, query, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCbIuOJeKNpJToMg2-PsblLtue-mzElUQY",
            authDomain: "tezz-95f0d.firebaseapp.com",
            projectId: "tezz-95f0d",
            storageBucket: "tezz-95f0d.firebasestorage.app",
            messagingSenderId: "87135277271",
            appId: "1:87135277271:web:49cc5d5ee7b473bfa7a092",
            measurementId: "G-D2WLJXGP67"
        };

        const appId = 'derya-ilker-love-v5'; // Yeni Temiz Veritabanƒ±
        let db, auth, currentUser = null;
        let mottos = [], quotes = {}, expertTips = [];
        let player, musicStarted = false;

        const defaultMottos = [
            "Yery√ºz√ºnde sevginin en g√º√ßl√º halidir aile.", "Mutluluk ve huzurdur aile.",
            "Bu hayattaki en b√ºy√ºk zenginlik ailedir.", "Aile, ko≈üulsuz sevgi demektir."
        ];

        const defaultTips = [
            "Duygusal baƒüƒ±n bedensel yolla peki≈ümesini saƒülar.", "Partnerler arasƒ±nda yakƒ±nlƒ±k ve samimiyeti artƒ±rƒ±r.",
            "Sevildiƒüini ve arzulandƒ±ƒüƒ±nƒ± hissettirebilir.", "ƒ∞li≈ükideki g√ºven duygusunu g√º√ßlendirebilir.",
            "Stresi azaltarak ili≈üki iklimini yumu≈üatƒ±r.", "√áiftler arasƒ±nda √∂zel ve payla≈üƒ±lan bir alan yaratƒ±r.",
            "S√∂zel olmayan bir ileti≈üim bi√ßimi sunar.", "ƒ∞li≈ükideki romantizmi canlƒ± tutabilir.",
            "Uzun s√ºreli ili≈ükilerde baƒülanmayƒ± destekler.", "√áatƒ±≈üma sonrasƒ± yakƒ±nla≈ümayƒ± kolayla≈ütƒ±rabilir."
        ];

        // --- BA≈ûLATMA ---
        const startApp = async () => {
            const savedUser = localStorage.getItem('romantik_user');
            if(savedUser) { currentUser = savedUser; updateUI(); }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await setPersistence(auth, browserLocalPersistence);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, u => { if(u) setupListeners(); });
            } catch(e) { console.error(e); }

            updateCounters();
            setInterval(updateCounters, 60000);
            
            // Enter Tu≈üu
            document.getElementById('chat-input').addEventListener('keydown', (e) => {
                if(e.key === 'Enter') window.sendChat();
            });
        };

        // --- VERƒ∞ AKI≈ûI ---
        const setupListeners = () => {
            // 1. Mottolar
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'config'), (doc) => {
                mottos = (doc.exists() && doc.data().mottos) ? doc.data().mottos : defaultMottos;
                expertTips = (doc.exists() && doc.data().tips) ? doc.data().tips : defaultTips;
                displayMotto();
                if(currentUser) { renderMottoList(); renderExpertSlider(); }
            });

            // 2. Mesajlar (Chat)
            onSnapshot(query(collection(db, 'artifacts', appId, 'chat'), orderBy('createdAt', 'desc')), (snap) => {
                const msgs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderChat(msgs);
            });

            // 3. G√ºnl√ºk S√∂zler
            onSnapshot(collection(db, 'artifacts', appId, 'quotes'), (snap) => {
                quotes = {};
                snap.docs.forEach(d => quotes[d.id] = d.data().text);
                displayDailyQuote();
                if(currentUser === 'ƒ∞lker') renderQuoteList();
            });

            // 4. Anƒ±lar
            onSnapshot(query(collection(db, 'artifacts', appId, 'memories'), orderBy('date', 'desc')), (snap) => {
                const mems = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderMemories(mems);
            });

            // 5. Talepler
            onSnapshot(collection(db, 'artifacts', appId, 'requests'), (snap) => {
                const reqs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderRequests(reqs);
            });
        };

        // --- UI RENDERERS ---
        function displayMotto() {
            const el = document.getElementById('daily-motto');
            const random = mottos[Math.floor(Math.random() * mottos.length)];
            el.innerText = `"${random}"`;
        }

        function displayDailyQuote() {
            const el = document.getElementById('current-quote');
            if(!currentUser) { el.innerText = "Giri≈ü yapƒ±ldƒ±ƒüƒ±nda y√ºklenecek..."; return; }
            
            const now = new Date();
            const key = `${String(now.getDate()).padStart(2,'0')}-${String(now.getMonth()+1).padStart(2,'0')}`;
            
            if (key === '08-02') el.innerText = '"Seni √ßok seviyorum"';
            else if (quotes[key]) el.innerText = `"${quotes[key]}"`;
            else {
                // Eƒüer bug√ºn yoksa en eski/rastgele birini g√∂ster
                const keys = Object.keys(quotes).sort();
                if(keys.length > 0) {
                     const idx = Math.floor(now.getTime() / 86400000) % keys.length;
                     el.innerText = `"${quotes[keys[idx]]}"`;
                } else el.innerText = '"Seni her g√ºn seviyorum..."';
            }
        }

        function renderExpertSlider() {
            const wrapper = document.getElementById('expert-slides');
            const today = new Date().getDate();
            const start = today % expertTips.length;
            const sorted = [...expertTips.slice(start), ...expertTips.slice(0, start)];
            
            wrapper.innerHTML = sorted.map(t => `<div class="swiper-slide info-slide"><p>${t}</p></div>`).join('');
            
            if(window.exSwiper) window.exSwiper.destroy();
            window.exSwiper = new Swiper(".expertSwiper", { direction: 'vertical', slidesPerView: 1, pagination: { clickable: true } });
        }

        function renderChat(msgs) {
            const div = document.getElementById('chat-box');
            div.innerHTML = msgs.map(m => `
                <div class="chat-bubble ${m.sender === currentUser ? 'sent' : 'received'}">
                    <div class="font-bold text-[10px] opacity-70 mb-1">${m.sender}</div>
                    <div>${m.text}</div>
                    <div class="chat-meta">${new Date(m.createdAt).toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'})} 
                    ${m.sender === currentUser ? `<button onclick="window.deleteChat('${m.id}')" class="text-white font-bold ml-2">x</button>` : ''}</div>
                </div>
            `).join('');
        }

        function renderRequests(reqs) {
            const incomingEl = document.getElementById('incoming-requests');
            const outgoingEl = document.getElementById('outgoing-requests');
            const incTitle = document.getElementById('incoming-req-title');
            const outTitle = document.getElementById('outgoing-req-title');

            const otherUser = currentUser === 'ƒ∞lker' ? 'Derya' : 'ƒ∞lker';
            
            incTitle.innerText = `${otherUser}'nƒ±n Senden ƒ∞stekleri (Zarf)`;
            outTitle.innerText = `Senin ${otherUser}'dan ƒ∞steklerin`;

            // Gelenler (Kapalƒ± Zarf)
            const incoming = reqs.filter(r => r.to === currentUser);
            incomingEl.innerHTML = incoming.map(r => `
                <div class="request-envelope" onclick="this.classList.toggle('open')">
                    <div class="flex justify-between items-center text-xs font-bold text-rose-500">
                        <span>üì© ${otherUser}'dan bir istek var</span>
                        <span>‚ñº</span>
                    </div>
                    <div class="request-content">${r.text}</div>
                </div>
            `).join('');

            // Gidenler (A√ßƒ±k Liste)
            const outgoing = reqs.filter(r => r.from === currentUser);
            outgoingEl.innerHTML = outgoing.map(r => `
                <div class="flex justify-between p-2 bg-white rounded border border-rose-100 text-sm">
                    <span>${r.text}</span>
                    <button onclick="window.deleteRequest('${r.id}')" class="text-rose-400 font-bold">x</button>
                </div>
            `).join('');
        }

        function renderMemories(mems) {
            const wrapper = document.getElementById('memory-slides');
            // Bug√ºne en yakƒ±n yƒ±ld√∂n√ºm√ºn√º bul
            const today = new Date();
            const sorted = mems.sort((a,b) => {
                const dA = new Date(a.date); const dB = new Date(b.date);
                const diffA = Math.abs((dA.getMonth() - today.getMonth())*30 + (dA.getDate() - today.getDate()));
                const diffB = Math.abs((dB.getMonth() - today.getMonth())*30 + (dB.getDate() - today.getDate()));
                return diffA - diffB;
            });

            wrapper.innerHTML = sorted.map(m => `
                <div class="swiper-slide memory-slide-card">
                    <div class="flex flex-col md:flex-row w-full h-full bg-white rounded-3xl overflow-hidden shadow-lg border border-rose-100">
                        ${m.photo ? `<div class="md:w-1/2 h-48 md:h-full bg-cover bg-center" style="background-image: url('${m.photo}')"></div>` : ''}
                        <div class="p-6 md:w-1/2 flex flex-col justify-center text-left">
                            <span class="bg-rose-100 text-rose-600 px-3 py-1 rounded-full text-xs font-bold w-fit mb-3">${new Date(m.date).toLocaleDateString('tr-TR')}</span>
                            <p class="text-rose-900 italic font-medium">"${m.text}"</p>
                            ${currentUser ? `<button onclick="window.deleteMemory('${m.id}')" class="mt-4 text-rose-300 text-xs font-bold text-right">Sƒ∞L</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            if(window.memSwiper) window.memSwiper.destroy();
            window.memSwiper = new Swiper(".memorySwiper", { 
                effect: "coverflow", grabCursor: true, centeredSlides: true, slidesPerView: "auto",
                coverflowEffect: { rotate: 50, stretch: 0, depth: 100, modifier: 1, slideShadows: false }
            });
        }
        
        function renderQuoteList() {
            const list = document.getElementById('saved-quotes-list');
            const keys = Object.keys(quotes).sort();
            list.innerHTML = keys.map(k => `<div class="flex justify-between p-2 border-b border-rose-50 text-xs"><span class="font-bold text-rose-500">${k}</span> <span class="truncate w-24">${quotes[k]}</span> <button onclick="window.deleteQuote('${k}')" class="text-rose-300">x</button></div>`).join('');
        }
        
        function renderMottoList() {
            const list = document.getElementById('motto-list');
            list.innerHTML = mottos.map((m,i) => `<div class="flex justify-between p-2 border-b border-rose-50 text-xs text-rose-800"><span>${m}</span> <button onclick="window.deleteMotto(${i})" class="text-rose-300">x</button></div>`).join('');
        }

        // --- GLOBAL ACTIONS ---
        window.login = (name) => {
            const p = prompt("≈ûifre:");
            if((name==='Derya' && p==='1881') || (name==='ƒ∞lker' && p==='1992')) {
                currentUser = name; localStorage.setItem('romantik_user', name); updateUI(); showToast(`Ho≈ü geldin ${name}`);
            } else showToast("Hatalƒ±!");
        };
        window.logout = () => { currentUser = null; localStorage.removeItem('romantik_user'); updateUI(); };
        window.toggleAdmin = () => document.getElementById('admin-panel').classList.toggle('translate-x-full');
        window.switchTab = (t) => {
            ['quotes','mottos','expert'].forEach(x => {
                document.getElementById(`sidebar-${x}-content`).className = x===t ? '' : 'hidden';
                document.getElementById(`tab-${x}`).className = x===t ? 'tab-btn active flex-1 text-[10px]' : 'tab-btn inactive flex-1 text-[10px]';
            });
        };

        function updateUI() {
            const els = document.querySelectorAll('.hidden-mode');
            els.forEach(e => e.style.display = currentUser ? 'block' : 'none');
            document.getElementById('mode-status').style.display = currentUser ? 'none' : 'block';
            document.getElementById('logout-btn').style.display = currentUser ? 'block' : 'none';
            document.getElementById('manage-btn').style.display = (currentUser === 'ƒ∞lker') ? 'block' : 'none';
            document.getElementById('private-content').style.display = currentUser ? 'block' : 'none';
            document.getElementById('counters-panel').style.display = currentUser ? 'flex' : 'none';
            
            // Verileri √ßek (Login olunca)
            if(currentUser && db) setupListeners(db, {uid: 'user'});
        }

        function updateCounters() {
             const now = new Date();
             const mD = new Date('2019-10-27'); const tD = new Date('2011-12-10');
             document.getElementById('marriage-counter').innerText = Math.floor((now - mD)/86400000);
             document.getElementById('meeting-counter').innerText = Math.floor((now - tD)/86400000);
        }

        // --- CRUD ACTIONS ---
        window.sendChat = async () => {
            const txt = document.getElementById('chat-input').value;
            if(!txt) return;
            await addDoc(collection(db, 'artifacts', appId, 'chat'), { text: txt, sender: currentUser, createdAt: Date.now() });
            document.getElementById('chat-input').value = '';
        };
        window.deleteChat = async (id) => await deleteDoc(doc(db, 'artifacts', appId, 'chat', id));

        window.addRequest = async () => {
            const txt = document.getElementById('request-input').value;
            if(!txt) return;
            // Derya eklerse -> 'from': Derya, 'to': ƒ∞lker
            const toUser = currentUser === 'ƒ∞lker' ? 'Derya' : 'ƒ∞lker';
            await addDoc(collection(db, 'artifacts', appId, 'requests'), { text: txt, from: currentUser, to: toUser, createdAt: Date.now() });
            document.getElementById('request-input').value = '';
        };
        window.deleteRequest = async (id) => await deleteDoc(doc(db, 'artifacts', appId, 'requests', id));

        window.saveMemoryFromMain = async () => {
            const f = document.getElementById('main-memory-photo').files[0];
            const t = document.getElementById('main-memory-text').value;
            const d = document.getElementById('main-memory-date').value;
            let url = null;
            if(f) url = await new Promise(r => { const rd = new FileReader(); rd.onload=()=>r(rd.result); rd.readAsDataURL(f); });
            await addDoc(collection(db, 'artifacts', appId, 'memories'), { text: t, date: d, photo: url, createdAt: Date.now() });
            showToast("Anƒ± eklendi!");
        };
        window.deleteMemory = async (id) => { if(confirm('Sil?')) await deleteDoc(doc(db, 'artifacts', appId, 'memories', id)); };

        window.saveDailyQuote = async () => {
            const d = document.getElementById('quote-date').value;
            const t = document.getElementById('daily-quote-text').value;
            if(!d || !t) return;
            const dateObj = new Date(d);
            const key = `${String(dateObj.getDate()).padStart(2,'0')}-${String(dateObj.getMonth()+1).padStart(2,'0')}`;
            await setDoc(doc(db, 'artifacts', appId, 'quotes', key), { text: t });
            showToast("Kaydedildi!");
        };
        window.deleteDailyQuote = async (k) => await deleteDoc(doc(db, 'artifacts', appId, 'quotes', k));

        window.addMotto = async () => {
            const t = document.getElementById('new-motto-text').value;
            if(!t) return;
            const newList = [...mottos, t];
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'mottos'), { list: newList, tips: expertTips });
            document.getElementById('new-motto-text').value = '';
        };
        window.deleteMotto = async (i) => {
             const newList = mottos.filter((_, idx) => idx !== i);
             await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'mottos'), { list: newList, tips: expertTips });
        };
        window.addExpertTip = async () => {
            const t = document.getElementById('new-expert-text').value;
            if(!t) return;
            const newList = [...expertTips, t];
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'mottos'), { list: mottos, tips: newList });
             document.getElementById('new-expert-text').value = '';
        };

        window.onYouTubeIframeAPIReady = () => { player = new YT.Player('player', { height:'0', width:'0', videoId:'7VUu1TuDjRI', playerVars:{'autoplay':1,'loop':1,'playlist':'7VUu1TuDjRI,hUB9M88kAdI'} }); };
        window.togglePlay = () => { if(player.getPlayerState()===1) player.pauseVideo(); else player.playVideo(); };
        window.nextSong = () => player.nextVideo();
        window.prevSong = () => player.previousVideo();
        window.playMusicOnFirstInteraction = () => { if(!musicStarted && player) { player.unMute(); player.playVideo(); musicStarted=true; document.body.onclick=null; } };

        startApp();
    </script>
</body>
</html>
